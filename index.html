<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Strangers</title>
    <!-- Include PeerJS from CDN with a specific version known to work -->
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #e0e0e0;
            --text-secondary: #909090;
            --accent: #00ff9d;
            --accent-dark: #00cc7d;
            --accent-glow: rgba(0, 255, 157, 0.2);
            --danger: #ff3a4c;
            --success: #00ff9d;
            --warning: #ffbb00;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            background-color: var(--bg-secondary);
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        header h1 {
            color: var(--accent);
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .container {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        #setup-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        #setup-screen h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        #my-id-display {
            padding: 1rem;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            word-break: break-all;
            border: 1px solid #222;
        }
        
        #my-id {
            color: var(--accent);
            font-weight: bold;
            font-family: monospace;
        }
        
        #connect-form {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            width: 100%;
            max-width: 400px;
        }
        
        #connect-form h3 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        #peer-id-input {
            padding: 0.8rem 1rem;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid #222;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        #peer-id-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }
        
        #chat-screen {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        #connection-status {
            padding: 1rem;
            background-color: var(--bg-tertiary);
            margin-bottom: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #222;
        }
        
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            min-height: 300px;
            max-height: 60vh;
            border: 1px solid #222;
        }
        
        #messages::-webkit-scrollbar {
            width: 6px;
        }
        
        #messages::-webkit-scrollbar-thumb {
            background-color: var(--accent-dark);
            border-radius: 6px;
        }
        
        #messages::-webkit-scrollbar-track {
            background-color: var(--bg-secondary);
            border-radius: 6px;
        }
        
        .message {
            padding: 0.8rem 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-break: break-word;
            line-height: 1.4;
        }
        
        .message.sent {
            background-color: var(--accent-dark);
            align-self: flex-end;
            color: #000;
            font-weight: 500;
        }
        
        .message.received {
            background-color: #222;
            align-self: flex-start;
        }
        
        .username {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 0.2rem;
            font-weight: 600;
        }
        
        #message-form {
            display: flex;
            gap: 0.5rem;
        }
        
        input, button {
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        #message-input {
            flex: 1;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid #222;
        }
        
        #message-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }
        
        button {
            background-color: var(--accent);
            color: #000;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--accent-dark);
        }
        
        button:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        #disconnect-btn {
            background-color: var(--danger);
            color: white;
            margin-top: 1rem;
        }
        
        #disconnect-btn:hover {
            background-color: #e6293a;
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .status-connecting {
            color: var(--warning);
        }
        
        .status-connected {
            color: var(--success);
        }
        
        .status-disconnected {
            color: var(--danger);
        }
        
        #error-display {
            color: var(--danger);
            padding: 1rem;
            margin-top: 1rem;
            background-color: rgba(255, 58, 76, 0.1);
            border-radius: 4px;
            text-align: center;
            display: none;
            border: 1px solid rgba(255, 58, 76, 0.3);
        }
        
        #debug-log {
            background-color: #0a0a0a;
            color: var(--accent);
            padding: 0.8rem;
            font-family: monospace;
            height: 100px;
            overflow-y: auto;
            margin-top: 1rem;
            font-size: 0.8rem;
            white-space: pre-wrap;
            border-radius: 4px;
            border: 1px solid #222;
        }
        
        /* Online users panel styles */
        #online-users-panel {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid #222;
            width: 100%;
        }
        
        #online-users-panel h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        #online-count {
            background-color: var(--accent);
            color: #000;
            border-radius: 12px;
            padding: 0.2rem 0.6rem;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        #users-list {
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        #users-list::-webkit-scrollbar {
            width: 6px;
        }
        
        #users-list::-webkit-scrollbar-thumb {
            background-color: var(--accent-dark);
            border-radius: 6px;
        }
        
        #users-list::-webkit-scrollbar-track {
            background-color: var(--bg-secondary);
            border-radius: 6px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem;
            border-bottom: 1px solid #222;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-item .user-name {
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .user-item .user-name::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .user-item .user-id {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-family: monospace;
        }
        
        .user-item.current-user {
            background-color: rgba(0, 255, 157, 0.1);
        }
        
        .connect-icon {
            cursor: pointer;
            color: var(--accent);
            margin-left: 0.5rem;
        }
        
        /* Random chat button styles */
        #random-chat-wrapper {
            margin-bottom: 1.5rem;
            width: 100%;
            max-width: 400px;
        }
        
        #random-chat-btn {
            width: 100%;
            background-color: var(--warning);
            color: #000;
            font-size: 1.1rem;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: transform 0.2s, background-color 0.2s;
        }
        
        #random-chat-btn:hover {
            background-color: #e6a800;
            transform: translateY(-2px);
        }
        
        #random-chat-btn:active {
            transform: translateY(0);
        }
        
        #random-chat-btn:disabled {
            background-color: #665000;
            transform: none;
        }
        
        #random-chat-btn .icon {
            font-size: 1.2rem;
        }
        
        /* Random chat animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .random-connecting {
            animation: pulse 1s infinite;
        }
        
        /* Modal/popup styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s;
            border: 1px solid #333;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-title {
            color: var(--accent);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .modal-actions button {
            min-width: 100px;
        }
        
        .btn-decline {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-decline:hover {
            background-color: #e6293a;
        }
        
        /* User avatar in chat request */
        .user-avatar {
            width: 64px;
            height: 64px;
            background-color: var(--accent-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.8rem;
            color: #000;
            font-weight: bold;
        }
        
        /* Request countdown */
        .request-countdown {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }
        
        /* Simple animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #setup-screen, #chat-screen {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Status indicator for request */
        .request-pending {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            background-color: var(--warning);
            color: #000;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Chat with Strangers</h1>
    </header>
    
    <div class="container">
        <div id="setup-screen">
            <h2>Find Someone to Chat With</h2>
            
            <!-- Random chat button -->
            <div id="random-chat-wrapper">
                <button id="random-chat-btn">
                    <span class="icon">🎲</span>
                    Chat with Random Person
                </button>
            </div>
            
            <!-- Online users panel -->
            <div id="online-users-panel">
                <h3>
                    Online Users
                    <span id="online-count">0</span>
                </h3>
                <div id="users-list">
                    <div class="user-item">
                        <div>
                            <span class="user-name">Loading users...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="my-id-display">
                <p>Your ID: <span id="my-id">Connecting...</span></p>
                <p>Share this ID with someone you want to chat with.</p>
            </div>
            
            <form id="connect-form">
                <h3>Connect to someone</h3>
                <input type="text" id="peer-id-input" placeholder="Enter their ID here...">
                <button type="submit" id="connect-btn">Connect</button>
            </form>
            
            <div id="error-display"></div>
        </div>
        
        <div id="chat-screen">
            <div id="connection-status">
                <p id="status-text" class="status-disconnected">Disconnected</p>
                <p id="username-display"></p>
            </div>
            
            <div id="messages"></div>
            
            <form id="message-form">
                <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" disabled>
                <button type="submit" id="send-btn" disabled>Send</button>
            </form>
            
            <button id="disconnect-btn">Disconnect</button>
        </div>
        
        <div id="debug-log"></div>
    </div>
    
    <!-- Chat request modal -->
    <div class="modal-overlay" id="request-modal">
        <div class="modal-content">
            <div class="user-avatar" id="request-avatar">?</div>
            <h3 class="modal-title">Chat Request</h3>
            <div class="modal-body" id="request-message">
                Someone wants to chat with you!
            </div>
            <div class="request-countdown" id="request-countdown">
                Expires in: 30s
            </div>
            <div class="modal-actions">
                <button class="btn-decline" id="decline-request">Decline</button>
                <button id="accept-request">Accept</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Chat with Strangers &copy; 2025</p>
    </footer>

    <script>
        // DOM Elements
const setupScreen = document.getElementById('setup-screen');
const chatScreen = document.getElementById('chat-screen');
const myIdDisplay = document.getElementById('my-id');
const peerIdInput = document.getElementById('peer-id-input');
const connectForm = document.getElementById('connect-form');
const connectBtn = document.getElementById('connect-btn');
const disconnectBtn = document.getElementById('disconnect-btn');
const statusText = document.getElementById('status-text');
const usernameDisplay = document.getElementById('username-display');
const messagesContainer = document.getElementById('messages');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const errorDisplay = document.getElementById('error-display');
const debugLog = document.getElementById('debug-log');
const onlineCount = document.getElementById('online-count');
const usersList = document.getElementById('users-list');
const randomChatBtn = document.getElementById('random-chat-btn');

// Request modal elements
const requestModal = document.getElementById('request-modal');
const requestMessage = document.getElementById('request-message');
const requestAvatar = document.getElementById('request-avatar');
const requestCountdown = document.getElementById('request-countdown');
const acceptRequestBtn = document.getElementById('accept-request');
const declineRequestBtn = document.getElementById('decline-request');

// Initially hide chat screen
chatScreen.style.display = 'none';

// Variables
let peer;
let connection;
let localUsername;
let remoteUsername;
let isConnected = false;
let myPeerId;
let isRandomConnecting = false;

// Request management variables
let pendingRequest = null;
let pendingRequestTimeout = null;
let outgoingRequests = new Map(); // Map of peerId -> {timestamp, timeout}
const REQUEST_TIMEOUT = 30000; // 30 seconds before request expires

// User tracker variables
let trackerConnection;
const TRACKER_SERVER_ID = 'user-tracker-server';
let onlineUsers = new Map(); // Map of peerId -> username
let heartbeatInterval;

// Debug log function
function log(message) {
    console.log(message);
    const now = new Date().toLocaleTimeString();
    debugLog.innerHTML += `[${now}] ${message}\n`;
    debugLog.scrollTop = debugLog.scrollHeight;
}

// Show error
function showError(message) {
    errorDisplay.textContent = message;
    errorDisplay.style.display = 'block';
    setTimeout(() => {
        errorDisplay.style.display = 'none';
    }, 5000);
}

// Generate a random username
function generateUsername() {
    const adjectives = ['Happy', 'Clever', 'Brave', 'Witty', 'Gentle', 'Bold', 'Calm', 'Eager', 'Fair', 'Kind'];
    const nouns = ['Wolf', 'Bear', 'Tiger', 'Lion', 'Eagle', 'Hawk', 'Fox', 'Owl', 'Dolphin', 'Panther'];
    const randomNumber = Math.floor(Math.random() * 1000);
    const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
    const noun = nouns[Math.floor(Math.random() * nouns.length)];
    return `${adj}${noun}${randomNumber}`;
}

// Generate a simple ID
function generateSimpleId() {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 6; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}

// Get initials for avatar
function getInitials(name) {
    if (!name) return '?';
    return name.charAt(0).toUpperCase();
}

// Update online users UI
function updateOnlineUsersUI() {
    // Update the count
    onlineCount.textContent = onlineUsers.size;
    
    // Clear the list
    usersList.innerHTML = '';
    
    // Add each user
    onlineUsers.forEach((username, peerId) => {
        const userItem = document.createElement('div');
        userItem.classList.add('user-item');
        
        // Highlight current user
        if (peerId === myPeerId) {
            userItem.classList.add('current-user');
        }
        
        const userInfo = document.createElement('div');
        
        const userName = document.createElement('span');
        userName.classList.add('user-name');
        userName.textContent = username;
        
        // Add pending indicator if we have an outgoing request
        if (outgoingRequests.has(peerId)) {
            const pendingIndicator = document.createElement('span');
            pendingIndicator.classList.add('request-pending');
            pendingIndicator.textContent = 'Request Sent';
            userName.appendChild(pendingIndicator);
        }
        
        const userId = document.createElement('span');
        userId.classList.add('user-id');
        userId.textContent = ` (${peerId})`;
        
        userInfo.appendChild(userName);
        userInfo.appendChild(userId);
        userItem.appendChild(userInfo);
        
        // Add connect button for other users if not already connected and no pending request
        if (peerId !== myPeerId && !isConnected && !outgoingRequests.has(peerId)) {
            const connectIcon = document.createElement('span');
            connectIcon.classList.add('connect-icon');
            connectIcon.textContent = '→ Connect';
            connectIcon.onclick = () => {
                peerIdInput.value = peerId;
                sendChatRequest(peerId);
            };
            userItem.appendChild(connectIcon);
        }
        
        usersList.appendChild(userItem);
    });
    
    // Update random chat button availability
    updateRandomChatButton();
}

// Show chat request popup
function showChatRequestPopup(requesterId, username) {
    // Set request info
    requestAvatar.textContent = getInitials(username);
    requestMessage.textContent = `${username} wants to chat with you!`;
    
    // Show modal
    requestModal.classList.add('active');
    
    // Set up countdown timer
    let timeLeft = REQUEST_TIMEOUT / 1000;
    updateCountdown();
    
    function updateCountdown() {
        requestCountdown.textContent = `Expires in: ${timeLeft}s`;
        if (timeLeft > 0) {
            timeLeft--;
            pendingRequestTimeout = setTimeout(updateCountdown, 1000);
        } else {
            declineChatRequest();
        }
    }
    
    // Setup accept/decline handlers
    function handleAccept() {
        clearTimeout(pendingRequestTimeout);
        requestModal.classList.remove('active');
        acceptChatRequest(requesterId);
        removeEventListeners();
    }
    
    function handleDecline() {
        clearTimeout(pendingRequestTimeout);
        requestModal.classList.remove('active');
        declineChatRequest();
        removeEventListeners();
    }
    
    function removeEventListeners() {
        acceptRequestBtn.removeEventListener('click', handleAccept);
        declineRequestBtn.removeEventListener('click', handleDecline);
    }
    
    // Add event listeners
    acceptRequestBtn.addEventListener('click', handleAccept);
    declineRequestBtn.addEventListener('click', handleDecline);
    
    // Store the pending request
    pendingRequest = {
        peerId: requesterId,
        username: username
    };
}

// Accept a chat request
function acceptChatRequest(requesterId) {
    log(`Accepted chat request from: ${requesterId}`);
    
    // Clear pending request
    pendingRequest = null;
    
    // Connect to the requester
    connectToPeer(requesterId);
    
    // Send accept message to requester
    try {
        const acceptConn = peer.connect(requesterId, {
            reliable: true,
            metadata: { type: 'request-response' }
        });
        
        acceptConn.on('open', () => {
            acceptConn.send({
                type: 'request-accepted',
                username: localUsername
            });
        });
    } catch (error) {
        log(`Error sending accept: ${error.message}`);
    }
}

// Decline a chat request
function declineChatRequest() {
    if (!pendingRequest) return;
    
    log(`Declined chat request from: ${pendingRequest.peerId}`);
    
    // Send decline message to requester
    try {
        const declineConn = peer.connect(pendingRequest.peerId, {
            reliable: true,
            metadata: { type: 'request-response' }
        });
        
        declineConn.on('open', () => {
            declineConn.send({
                type: 'request-declined'
            });
            
            // Close after sending
            setTimeout(() => {
                declineConn.close();
            }, 1000);
        });
    } catch (error) {
        log(`Error sending decline: ${error.message}`);
    }
    
    // Clear pending request
    pendingRequest = null;
}

// Send a chat request to another user
function sendChatRequest(peerId) {
    if (!peerId || isConnected) return;
    
    log(`Sending chat request to: ${peerId}`);
    
    try {
        // Create a connection specifically for the request
        const requestConn = peer.connect(peerId, {
            reliable: true,
            metadata: { type: 'chat-request' }
        });
        
        requestConn.on('open', () => {
            // Send the request
            requestConn.send({
                type: 'chat-request',
                peerId: myPeerId,
                username: localUsername
            });
            
            // Show status in UI
            showError(`Chat request sent to ${onlineUsers.get(peerId) || peerId}`);
            
            // Track this outgoing request
            const timeout = setTimeout(() => {
                // Request timed out
                outgoingRequests.delete(peerId);
                requestConn.close();
                showError('Chat request expired');
                updateOnlineUsersUI();
            }, REQUEST_TIMEOUT);
            
            outgoingRequests.set(peerId, {
                timestamp: Date.now(),
                timeout: timeout,
                connection: requestConn
            });
            
            // Update UI to show pending
            updateOnlineUsersUI();
        });
        
        requestConn.on('data', (data) => {
            log(`Received request response: ${JSON.stringify(data)}`);
            
            if (data.type === 'request-accepted') {
                // Clear request timeout
                clearTimeout(outgoingRequests.get(peerId).timeout);
                outgoingRequests.delete(peerId);
                
                // Request accepted, connection will happen separately
                showError(`${data.username} accepted your chat request!`);
                
                // Store their username for the chat
                remoteUsername = data.username;
                
                connectToPeer(peerId);
            } else if (data.type === 'request-declined') {
                // Clear request timeout
                clearTimeout(outgoingRequests.get(peerId).timeout);
                outgoingRequests.delete(peerId);
                
                // Show declined message
                showError('Chat request was declined');
                
                // Close this connection
                requestConn.close();
                
                // Update UI
                updateOnlineUsersUI();
            }
        });

        requestConn.on('error', (err) => {
            log(`Request connection error: ${err.message}`);
            outgoingRequests.delete(peerId);
            updateOnlineUsersUI();
        });
    } catch (error) {
        log(`Error creating request connection: ${error.message}`);
        showError(`Failed to send request: ${error.message}`);
    }
}

// Initialize the chat app
function initializeChat() {
    // Generate a username and ID for the user
    localUsername = generateUsername();
    const peerId = generateSimpleId();
    
    log(`Generated username: ${localUsername}`);
    
    // Initialize the peer connection
    peer = new Peer(peerId, {
        debug: 2
    });
    
    // Handle peer events
    peer.on('open', (id) => {
        myPeerId = id;
        log(`Connected with peer ID: ${id}`);
        myIdDisplay.textContent = id;
        
        // Connect to tracker server
        connectToTracker();
    });
    
    peer.on('connection', (conn) => {
        // Check if this is a chat request
        if (conn.metadata && conn.metadata.type === 'chat-request') {
            handleChatRequest(conn);
            return;
        }
        
        // Check if this is a request response
        if (conn.metadata && conn.metadata.type === 'request-response') {
            // This will be handled by the request connection's data event
            return;
        }
        
        // Only accept one connection at a time
        if (isConnected) {
            conn.on('open', () => {
                conn.send({ 
                    type: 'busy',
                    message: 'User is already in a chat'
                });
                setTimeout(() => conn.close(), 1000);
            });
            return;
        }
        
        log('Incoming connection...');
        
        // Handle the connection
        handleConnection(conn);
    });
    
    peer.on('error', (err) => {
        log(`Peer error: ${err.type} - ${err.message}`);
        showError(`Connection error: ${err.message}`);
    });
    
    peer.on('disconnected', () => {
        log('Disconnected from PeerJS server');
        
        // Attempt to reconnect
        peer.reconnect();
    });
    
    // Set up UI events
    connectForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const peerId = peerIdInput.value.trim();
        if (peerId) {
            sendChatRequest(peerId);
        }
    });
    
    messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message && isConnected) {
            sendMessage(message);
            messageInput.value = '';
        }
    });
    
    disconnectBtn.addEventListener('click', () => {
        disconnect();
    });
    
    randomChatBtn.addEventListener('click', () => {
        if (isRandomConnecting) return;
        connectToRandomUser();
    });
    
    // Hide chat screen initially
    chatScreen.style.display = 'none';
    setupScreen.style.display = 'block';
}

// Handle incoming chat request
function handleChatRequest(conn) {
    conn.on('open', () => {
        log('Chat request connection open');
    });
    
    conn.on('data', (data) => {
        if (data.type === 'chat-request') {
            log(`Chat request from: ${data.peerId} (${data.username})`);
            
            // Only process if not already in a chat and no pending request
            if (!isConnected && !pendingRequest) {
                // Show the request popup
                showChatRequestPopup(data.peerId, data.username);
            } else {
                // Send busy message
                conn.send({
                    type: 'busy',
                    message: isConnected ? 'User is already in a chat' : 'User has a pending request'
                });
            }
        }
    });
    
    conn.on('error', (err) => {
        log(`Chat request error: ${err.message}`);
    });
}

// Connect to peer
function connectToPeer(peerId) {
    if (isConnected) return;
    
    log(`Connecting to peer: ${peerId}`);
    
    try {
        const conn = peer.connect(peerId, {
            reliable: true
        });
        
        handleConnection(conn);
    } catch (error) {
        log(`Connection error: ${error.message}`);
        showError(`Failed to connect: ${error.message}`);
    }
}

// Handle connection
function handleConnection(conn) {
    // Update UI to connecting state
    statusText.textContent = 'Connecting...';
    statusText.className = 'status-connecting';
    
    // Store connection
    connection = conn;
    
    // Handle connection events
    conn.on('open', () => {
        log('Connection established');
        
        // Set connected status
        isConnected = true;
        
        // Enable chat UI
        enableChatUI();
        
        // Send initial data
        conn.send({
            type: 'user-info',
            username: localUsername
        });
    });
    
    conn.on('data', (data) => {
        log(`Received data: ${JSON.stringify(data)}`);
        
        if (data.type === 'user-info') {
            // Store remote username
            remoteUsername = data.username;
            usernameDisplay.textContent = `Chatting with: ${remoteUsername}`;
        } else if (data.type === 'message') {
            // Display received message
            addMessage(data.message, false);
        } else if (data.type === 'busy') {
            showError(data.message);
            disconnect();
        }
    });
    
    conn.on('close', () => {
        log('Connection closed');
        disconnect();
    });
    
    conn.on('error', (err) => {
        log(`Connection error: ${err.message}`);
        showError(`Connection error: ${err.message}`);
        disconnect();
    });
}

// Send a message
function sendMessage(message) {
    if (!connection || !isConnected) return;
    
    try {
        connection.send({
            type: 'message',
            message: message
        });
        
        // Display sent message
        addMessage(message, true);
    } catch (error) {
        log(`Error sending message: ${error.message}`);
        showError(`Failed to send message: ${error.message}`);
    }
}

// Add message to chat
function addMessage(message, isSent) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    messageElement.classList.add(isSent ? 'sent' : 'received');
    
    // Add username label
    const usernameElement = document.createElement('div');
    usernameElement.classList.add('username');
    usernameElement.textContent = isSent ? localUsername : remoteUsername || 'Stranger';
    
    // Add message text
    const textElement = document.createElement('div');
    textElement.textContent = message;
    
    // Build message
    messageElement.appendChild(usernameElement);
    messageElement.appendChild(textElement);
    
    // Add to container
    messagesContainer.appendChild(messageElement);
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Enable chat UI
function enableChatUI() {
    setupScreen.style.display = 'none';
    chatScreen.style.display = 'flex';
    
    statusText.textContent = 'Connected';
    statusText.className = 'status-connected';
    
    messageInput.disabled = false;
    sendBtn.disabled = false;
    messageInput.focus();
}

// Disable chat UI
function disableChatUI() {
    setupScreen.style.display = 'block';
    chatScreen.style.display = 'none';
    
    statusText.textContent = 'Disconnected';
    statusText.className = 'status-disconnected';
    usernameDisplay.textContent = '';
    
    messageInput.disabled = true;
    sendBtn.disabled = true;
    
    // Clear messages
    messagesContainer.innerHTML = '';
}

// Disconnect
function disconnect() {
    if (connection) {
        connection.close();
        connection = null;
    }
    
    isConnected = false;
    remoteUsername = null;
    
    disableChatUI();
    log('Disconnected');
}

// Connect to tracker server
function connectToTracker() {
    log('Connecting to tracker server...');
    
    try {
        trackerConnection = peer.connect(TRACKER_SERVER_ID, {
            reliable: true,
            metadata: { type: 'tracker' }
        });
        
        trackerConnection.on('open', () => {
            log('Connected to tracker server');
            
            // Register with the tracker
            trackerConnection.send({
                type: 'register',
                peerId: myPeerId,
                username: localUsername
            });
            
            // Start heartbeat
            startHeartbeat();
        });
        
        trackerConnection.on('data', (data) => {
            if (data.type === 'user-list') {
                // Update online users
                onlineUsers = new Map(data.users);
                updateOnlineUsersUI();
            }
        });
        
        trackerConnection.on('close', () => {
            log('Tracker connection closed');
            clearInterval(heartbeatInterval);
            
            // Try to reconnect after a delay
            setTimeout(() => {
                if (!trackerConnection) {
                    connectToTracker();
                }
            }, 5000);
        });
        
        trackerConnection.on('error', (err) => {
            log(`Tracker error: ${err.message}`);
            clearInterval(heartbeatInterval);
            trackerConnection = null;
            
            // Try to reconnect after a delay
            setTimeout(connectToTracker, 5000);
        });
    } catch (error) {
        log(`Error connecting to tracker: ${error.message}`);
        setTimeout(connectToTracker, 5000);
    }
}

// Start heartbeat interval
function startHeartbeat() {
    clearInterval(heartbeatInterval);
    
    // Send heartbeat every 30 seconds
    heartbeatInterval = setInterval(() => {
        if (trackerConnection && trackerConnection.open) {
            trackerConnection.send({
                type: 'heartbeat',
                peerId: myPeerId
            });
        }
    }, 30000);
}

// Connect to a random online user
function connectToRandomUser() {
    // Get all online users except ourselves
    const availableUsers = Array.from(onlineUsers.keys())
        .filter(id => id !== myPeerId);
    
    if (availableUsers.length === 0) {
        showError('No other users online');
        return;
    }
    
    // Pick a random user
    const randomIndex = Math.floor(Math.random() * availableUsers.length);
    const randomPeerId = availableUsers[randomIndex];
    
    // Start connecting
    isRandomConnecting = true;
    randomChatBtn.classList.add('random-connecting');
    randomChatBtn.disabled = true;
    randomChatBtn.textContent = 'Finding someone...';
    
    // Send chat request
    sendChatRequest(randomPeerId);
    
    // Reset button after timeout
    setTimeout(() => {
        isRandomConnecting = false;
        randomChatBtn.classList.remove('random-connecting');
        randomChatBtn.disabled = false;
        randomChatBtn.innerHTML = '<span class="icon">🎲</span> Chat with Random Person';
    }, 8000);
}

// Update random chat button state
function updateRandomChatButton() {
    const availableUsers = Array.from(onlineUsers.keys())
        .filter(id => id !== myPeerId);
    
    randomChatBtn.disabled = availableUsers.length === 0 || isConnected || isRandomConnecting;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initializeChat);
</script>
</body>
</html>
